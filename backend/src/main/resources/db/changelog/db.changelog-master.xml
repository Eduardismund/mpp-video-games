<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.29.xsd">

  <changeSet id="1" author="eduardismund">
    <createTable tableName="video_game">
      <column name="id" type="varchar(255)">
        <constraints primaryKey="true" primaryKeyName="video_game_pk"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="genre" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="price" type="decimal(10,2)">
        <constraints nullable="false"/>
      </column>
      <column name="release_date" type="date">
        <constraints nullable="false"/>
      </column>
      <column name="name_hashed" type="BIGINT">
        <constraints nullable="false" unique="true" uniqueConstraintName="video_game_name_hashed_uk"/>
      </column>
      <column name="image" type="varchar(255)"/>
    </createTable>

    <createTable tableName="video_game_review">
      <column name="id" type="VARCHAR(255)">
        <constraints primaryKey="true" primaryKeyName="video_game_review_pk"/>
      </column>
      <column name="text" type="VARCHAR(400)"/>
      <column name="score" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="timestamp" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="video_game_id" type="varchar(255)">
        <constraints nullable="false" foreignKeyName="video_game_review_fk" referencedTableName="video_game"
                     referencedColumnNames="id"/>
      </column>
    </createTable>

    <createIndex indexName="video_game_name_hashed_ix" tableName="video_game" unique="true">
      <column name="name_hashed"/>
    </createIndex>

    <createIndex indexName="video_game_price_ix" tableName="video_game">
      <column name="price"/>
    </createIndex>

    <createIndex indexName="video_game_genre_ix" tableName="video_game">
      <column name="genre"/>
    </createIndex>

    <createIndex indexName="video_game_release_date_ix" tableName="video_game">
      <column name="release_date"/>
    </createIndex>

    <createIndex indexName="video_game_review_video_game_id_ix" tableName="video_game_review">
      <column name="video_game_id"/>
    </createIndex>

    <createIndex indexName="video_game_review_score_ix" tableName="video_game_review">
      <column name="score"/>
    </createIndex>

    <createIndex indexName="video_game_review_timestamp_ix" tableName="video_game_review">
      <column name="timestamp"/>
    </createIndex>

    <sql>
      CREATE INDEX video_game_release_date_year_ix ON video_game (EXTRACT(YEAR FROM release_date));
    </sql>

  </changeSet>

  <changeSet id="2" author="eduardismund">
    <createTable tableName="user">
      <column name="id" type="VARCHAR(255)">
        <constraints primaryKey="true" primaryKeyName="user_pk"/>
      </column>
      <column name="username" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="password" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="role" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="token">
      <column name="id" type="VARCHAR(255)">
        <constraints primaryKey="true" primaryKeyName="token_pk"/>
      </column>
      <column name="token" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="varchar(255)">
        <constraints nullable="false" foreignKeyName="token_user_fk" referencedTableName="user"
                     referencedColumnNames="id"/>
      </column>
    </createTable>

    <createIndex indexName="user_username_ix" tableName="user" unique="true">
      <column name="username"/>
    </createIndex>

    <createIndex indexName="token_token_ix" tableName="token">
      <column name="token"/>
    </createIndex>

  </changeSet>

  <changeSet id="3" author="eduardismund">
    <insert tableName="user">
      <column name="id" value="1"/>
      <column name="username" value="user1"/>
      <column name="password" value="password"/> <!-- bcrypt or plain -->
      <column name="role" value="0"/> <!-- adjust this based on your enum mapping -->
    </insert>
  </changeSet>

  <changeSet id="4" author="eduardismund">
    <addColumn tableName="video_game">
      <column name="user_id" type="varchar(255)">
        <constraints foreignKeyName="video_game_user_fk" referencedTableName="user" referencedColumnNames="id"/>
      </column>
    </addColumn>
    <addColumn tableName="video_game_review">
      <column name="user_id" type="varchar(255)">
        <constraints foreignKeyName="video_game_review_user_fk" referencedTableName="user" referencedColumnNames="id"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="5" author="eduardismund">
    <update tableName="video_game">
      <column name="user_id" value="1"/>
    </update>
    <update tableName="video_game_review">
      <column name="user_id" value="1"/>
    </update>
  </changeSet>

  <changeSet id="6" author="eduardismund">
    <addNotNullConstraint
      tableName="video_game"
      columnName="user_id"
      columnDataType="VARCHAR(255)"/>
    <addNotNullConstraint
      tableName="video_game_review"
      columnName="user_id"
      columnDataType="VARCHAR(255)"/>
  </changeSet>

  <changeSet id="7" author="eduardismund">
    <insert tableName="user">
      <column name="id" value="2"/>
      <column name="username" value="user2"/>
      <column name="password" value="password"/>
      <column name="role" value="0"/>
    </insert>
  <insert tableName="user">
      <column name="id" value="3"/>
      <column name="username" value="user3"/>
      <column name="password" value="password"/>
      <column name="role" value="0"/>
    </insert>
  <insert tableName="user">
      <column name="id" value="4"/>
      <column name="username" value="user4"/>
      <column name="password" value="password"/>
      <column name="role" value="0"/>
    </insert>
  <insert tableName="user">
      <column name="id" value="5"/>
      <column name="username" value="user5"/>
      <column name="password" value="password"/>
      <column name="role" value="0"/>
    </insert>
  </changeSet>

  <changeSet id="8" author="eduardismund">
    <insert tableName="user">
      <column name="id" value="6"/>
      <column name="username" value="admin6"/>
      <column name="password" value="password"/>
      <column name="role" value="1"/>
    </insert>
  <insert tableName="user">
      <column name="id" value="7"/>
      <column name="username" value="admin7"/>
      <column name="password" value="password"/>
      <column name="role" value="1"/>
    </insert>
  </changeSet>

 <changeSet id="9" author="eduardismund">
    <createTable tableName="action_trail_item">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="action_trail_item_pk" />

      </column>
      <column name="action" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="timestamp" type="timestamp">
          <constraints nullable="false"/>
      </column>
      <column name="user_id" type="varchar(255)">
        <constraints foreignKeyName="action_trail_item_user_fk" referencedTableName="user" referencedColumnNames="id"/>
      </column>
    </createTable>
  </changeSet>

 <changeSet id="10" author="eduardismund">
    <createTable tableName="user_monitor">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="user_monitor_pk" />
      </column>
      <column name="reason" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="timestamp" type="timestamp">
          <constraints nullable="false"/>
      </column>
      <column name="user_id" type="varchar(255)">
        <constraints foreignKeyName="user_monitor_user_fk" referencedTableName="user" referencedColumnNames="id"/>
      </column>
    </createTable>

   <createIndex tableName="user_monitor" indexName="user_monitor_timestamp_ix">
     <column name="timestamp"/>
   </createIndex>

   <createIndex tableName="action_trail_item" indexName="action_trail_item_timestamp_ix">
     <column name="timestamp"/>
   </createIndex>
  </changeSet>


</databaseChangeLog>
